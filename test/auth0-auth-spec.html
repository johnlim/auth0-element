<!doctype html>

<html>
<head>
  <title>auth0-auth test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script src="../node_modules/wct-browser-legacy/browser.js"></script>

  <script>if (!window.customElements) { document.write('<!--'); }</script>
  <script type="text/javascript" src="../node_modules/@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js"></script>
  <!--! do not remove -->
  <script type="module" src="../build/js/main.min.js"></script>
  <!--<script type="module" src="../node_modules/@polymer/polymer/lib/elements/dom-bind.js"></script>-->
</head>
<body>

<test-fixture id="basic">
  <template>
    <auth0-auth></auth0-auth>
  </template>
</test-fixture>

<script type="module">
  var setLocalStorage = function() {
    localStorage.setItem('auth0:authUser', 'idToken' );
    localStorage.setItem('auth0:accessToken', 'accessToken');
  };

  var clearLocalStorage = function() {
    localStorage.removeItem('auth0:authUser');
    localStorage.removeItem('auth0:accessToken');
  };
//  suite('fasdfasdf', ()=>{
//    var auth0Lock, auth0, element;
//    setup(function () {
//      element = fixture('basic')
//      console.log('element.auth0lock', element.x)
//      auth0Lock = sinon.stub(element, 'y').returns({
//        show: function() {}
//      });
//      auth0 = sinon.stub(element.x, 'WebAuth').returns({
//        parseHash: function (fn) {
//          return fn(null, {accessToken: 'accessToken', idToken: 'idToken'})
//        },
//        client: {
//          userInfo: function (accessToken, fn) {
//            return fn(null, {user: 'userInfo'})
//          }
//        },
//        logout: function () {}
//      });
//    });
//
//    teardown(function () {
//      auth0Lock.restore();
//      auth0.restore();
//    });
//    test('instantiating the element works', function() {
//      var element = fixture('basic');
//      console.log('element', element.prop1)
//      console.log('element.y', element.y)
//      console.log('element.x', element.x)
//      assert.equal(element.prop1, 'auth0-element');
//    });
//
//  });
  suite('auth0-auth', function () {
    var auth0Lock, auth0, element;
    setup(function () {
      element = fixture('basic')
      console.log('element.auth0lock', element.x)
//      auth0Lock = sinon.stub(element, 'y').returns({
//        show: function () {
//        }
//      });
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {accessToken: 'accessToken', idToken: 'idToken'})
        },
        client: {
          userInfo: function (accessToken, fn) {
            return fn(null, {user: 'userInfo'})
          }
        },
        logout: function () {
        }
      });
    });

    teardown(function () {
//      auth0Lock.restore();
      auth0.restore();
    });
    test('_init is executed only when all parameters are defined', function() {
      var spy = sinon.stub(element, '_init');
      element.options = {};
      element.clientId = 'auth0-clientId';
      element.domain = 'auth0-domain';

      sinon.assert.calledWith(spy,'auth0-clientId', 'auth0-domain', {})
    });

    test('signOut logs the user out of application session by clearing localStorage', function() {
      console.log('element.clientId', element.clientId)
      //call _init so that auth0 will be initialised as it cannot be stubbed till its defined and we cannot assign it here as its set as read-only
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType:'token'}});
      sinon.stub(element.auth0, 'logout');
      localStorage.setItem(element.localStorageKey, "abc");
      element.signOut();
      assert.equal(null,localStorage.getItem("auth0:authUser"))
    });

    test('Signing out WITH client id results in app level signout', function() {
      element.logoutRedirectTo = 'localHost';
      //call _init so that auth0 will be initialised as it cannot be stubbed till its defined and we cannot assign it here as its set as read-only
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      var spy = sinon.stub(element.auth0, 'logout');
      element.signOut('abc');

      sinon.assert.calledWithExactly(spy, {returnTo: element.logoutRedirectTo, client_id: 'abc'}, {version: 'v2'});
    });

    test('Signing out WITHOUT client id results in account level signout', function() {
      element.logoutRedirectTo = 'abc';
      //call _init so that auth0 will be initialised as it cannot be stubbed till its defined and we cannot assign it here as its set as read-only
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      var spy = sinon.stub(element.auth0, 'logout');
      element.signOut();
      sinon.assert.calledWithExactly(spy, {returnTo: element.logoutRedirectTo, client_id: undefined}, {version: 'v2'});
    });
  });
//
//  suite('When authentication succeeds', function () {
//    var auth0Lock, auth0, element;
//    setup(function () {
//      element = fixture('basic');
//      clearLocalStorage();
//      auth0Lock = sinon.stub(element, 'y').returns({
//        show: function () {
//        }
//      });
//      auth0 = sinon.stub(element.x, 'WebAuth').returns({
//        parseHash: function (fn) {
//          return fn(null, {accessToken: 'accessToken', idToken: 'idToken'})
//        },
//        logout: function () {
//        },
//        client: {
//          userInfo: function (accessToken, fn) {
//            return fn(null, {user: 'userInfo'})
//          }
//        }
//      });
//    });
//
//    teardown(function () {
//      clearLocalStorage();
//      auth0Lock.restore();
//      auth0.restore();
//    });
//
//    test('User profile should be set', function () {
//      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
//      assert(element.userProfile);
//    });
//
//    test('id token will be stored to local storage', function () {
//      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
//      assert.equal('idToken',localStorage.getItem("auth0:authUser"))
//    });
//
//    test('access token will be stored to local storage', function () {
//      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
//      assert.equal('accessToken',localStorage.getItem("auth0:accessToken"))
//    });
//
//    test('id token property will be set', function () {
//      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
//      assert.equal('idToken', element.idToken)
//    });
//  });

  suite('When error occurs during authentication', function () {
    var auth0Lock, auth0, stubLockDotShow, element;
    setup(function () {
      element = fixture('basic');
      stubLockDotShow =  sinon.stub().returns("");
//      auth0Lock = sinon.createStubInstance(element.y, {})
//       auth0Lock.show.returns(
//        stubLockDotShow
//      );
      console.log('loc**********k', element.constructor.lock)
      auth0Lock = sinon.stub(element.constructor, 'lock').returns({
        show: function() {}
      });
    });

    teardown(function () {
      auth0Lock.restore();
    });

    test('User profile should NOT be set if authResult is null', function () {
      console.log('element.y.show', element.y)
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, null)
        },
        renewAuth: function(options, fn) {
          return fn({}, null)
        },
        checkSession: function (options, fn) {
          return fn({}, null)
        },
        authorize: function (options) {
          return function(){}
        }
      });
      console.log('auth0lock not stubbed x?', element.x);
      console.log('auth0lock not stubbed y?', element.y);
      console.log('auth0lock not stubbed z?', element.z.prototype.constructor);
//      element.hostedPages = true;
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert(!element.userProfile);
      auth0.restore();
    });

    test('User profile should NOT be set if authResult does not contain an access token', function () {
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {idToken: 'idToken'})
        },
        renewAuth: function(options, fn) {
          return fn({}, null)
        },
        checkSession: function (options, fn) {
          return fn({}, null)
        }
      });
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert(!element.userProfile);
      auth0.restore();
    });

    test('User profile should NOT be set if authResult does not contain an id token', function () {
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {accessToken: 'accessToken'})
        },
        renewAuth: function(options, fn) {
          return fn({}, null)
        },
        checkSession: function (options, fn) {
          return fn({}, null)
        }
      });
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert(!element.userProfile);
      auth0.restore();
    });

    test('User should be redirected to login', function () {
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {error: 'error'})
        },
        renewAuth: function(options, fn) {
          return fn({}, null)
        },
        checkSession: function (options, fn) {
          return fn({}, null)
        }
      });
      var element = fixture('basic');
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert.equal(stubLockDotShow.callCount, 1);
      auth0.restore();
    });

    test('Should redirect to hosted login page if useHostedPages set to true', function() {
      var stubAuthorize =  sinon.stub().returns("");
      auth0 = sinon.stub(element.x, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {error: 'error'})
        },
        renewAuth: function(options, fn) {
          return fn({}, null)
        },
        checkSession: function (options, fn) {
          return fn({}, null)
        },
        authorize: stubAuthorize
      });
      var element = fixture('basic');
      element.hostedPages = true;
      element.options = {auth: 'authOptions'};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      sinon.assert.calledWith(stubAuthorize, element.options.auth);
      assert.equal(stubAuthorize.callCount, 1);
      auth0.restore();
    });

  });

  suite('When user is already logged in', function() {
    var auth0;
    setup(function () {
      setLocalStorage();
      auth0 = sinon.stub(window.auth0, 'WebAuth').returns({
        client: {
          userInfo: function (accessToken, fn) {
            return fn(null, {user: 'userInfo'})
          }
        }
      });
    });

    teardown(function () {
      clearLocalStorage();
      auth0.restore();
    });

    test('User profile should be set', function() {
      var element = fixture('basic');
      element._tokenIsValid = function () {
        return true;
      };
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert(element.userProfile);
    });


    test('id token property will be set', function () {
      var element = fixture('basic');
      element._tokenIsValid = function () {
        return true;
      };
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert.equal('idToken', element.idToken)
    });

    test('user should be redirected to login if token has expired', function() {
      var element = fixture('basic');
      element._tokenIsValid = function () {
        return false;
      };
      assert(!element.userProfile);
    });


  });

  suite('When there is an active SSO session', function() {
    var auth0;
    setup(function () {
      clearLocalStorage();
      auth0 = sinon.stub(window.auth0, 'WebAuth').returns({
        parseHash: function (fn) {
          return fn(null, {error: 'error'})
        },
        renewAuth: function(options, fn) {
          return fn(null, {accessToken: 'accessToken', idToken: 'idToken'})
        },
        checkSession: function (options, fn) {
          return fn(null, {idToken: 'idToken', accessToken: 'accessToken'})
        },
        client: {
          userInfo: function (accessToken, fn) {
            return fn(null, {user: 'userInfo'})
          }
        }
      });
    });

    teardown(function () {
      clearLocalStorage();
      auth0.restore();
    });

    test('User profile should be set', function() {
      var element = fixture('basic');
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert(element.userProfile);
    });

    test('access token should be stored to local storage', function () {
      var element = fixture('basic');
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert.equal('accessToken',localStorage.getItem("auth0:accessToken"))
    });

    test('id token should be stored to local storage', function () {
      var element = fixture('basic');
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert.equal('idToken',localStorage.getItem("auth0:authUser"))
    });

    test('id token property will be set', function () {
      var element = fixture('basic');
      element.options = {auth: {scope: 'openId'}};
      element._init('auth0-clientId', 'auth0-domain', {auth: {redirectUri: '', responseType: 'token'}});
      assert.equal('idToken', element.idToken)
    });
  });

  suite('Monitoring of token expiry', function() {
    test('should be enabled when client explicitly enables it', function(done) {
      var element = fixture('basic');
      var monitor = sinon.stub(element, '_monitorExpiry');
      element._setUserProfile({user: 'userInfo'});
      element._setIdToken('idToken');
      element.jwtManager = true;

      flush(function () {
        sinon.assert.calledWith(monitor, element.idToken, true);
        done();
      })
    });

    test('should be disabled when client does not enable it', function(done) {
      var element = fixture('basic');
      var monitor = sinon.spy(element, '_monitorExpiry');
      element._setUserProfile({user: 'userInfo'});
      element._setIdToken('idToken');

      flush(function () {
        assert(monitor.returned(undefined));
        done();
      })
    });
  });

  suite('Handling of token expiry', function() {
    test('TODO: Need to add test', function(done) {
    });
  });
</script>
</body>
</html>
